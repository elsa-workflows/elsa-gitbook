# Resume Bookmark Examples (curl)

This document provides curl examples for resuming workflows via bookmarks.

## Token-Based Resume

When Elsa generates a bookmark URL (e.g., for HTTP callbacks or email approvals), it includes an encrypted token that identifies the bookmark.

**Code Reference:** `src/modules/Elsa.Http/Extensions/BookmarkExecutionContextExtensions.cs` — `GenerateBookmarkTriggerUrl` method.

### Basic Token Resume

```bash
# Resume using the tokenized URL
curl -X POST "https://your-elsa-server.com/elsa/api/bookmarks/resume?t=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Content-Type: application/json"
```

### Token Resume with Payload

```bash
# Resume with input data that the workflow can access
curl -X POST "https://your-elsa-server.com/elsa/api/bookmarks/resume?t=YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "status": "approved",
    "approvedBy": "manager@example.com",
    "comments": "Looks good to proceed"
  }'
```

**Expected Responses:**

| Status | Meaning |
|--------|---------|
| 200 OK | Workflow resumed successfully |
| 401 Unauthorized | Token invalid |
| 404 Not Found | Bookmark not found (may be expired or already consumed) |
| 410 Gone | Bookmark expired or workflow cancelled |

---

## Stimulus-Based Resume

For programmatic resume without a token, provide the stimulus payload that matches the bookmark's expected input.

**Code Reference:** `src/modules/Elsa.Workflows.Core/Bookmarks/` — Stimulus hashing implementation.

### HTTP Endpoint Resume

Resume a workflow waiting on an HTTP endpoint:

```bash
curl -X POST "https://your-elsa-server.com/elsa/api/bookmarks/resume" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "activityTypeName": "Elsa.HttpEndpoint",
    "stimulus": {
      "path": "/webhook/order-approved",
      "method": "POST"
    },
    "input": {
      "orderId": "ORD-12345",
      "status": "approved"
    }
  }'
```

### Signal-Based Resume

Resume a workflow waiting on a signal:

```bash
curl -X POST "https://your-elsa-server.com/elsa/api/bookmarks/resume" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "activityTypeName": "Elsa.RunTask",
    "stimulus": {
      "taskName": "approval-required"
    },
    "correlationId": "order-12345",
    "input": {
      "approved": true,
      "approverName": "John Manager"
    }
  }'
```

### Resume by Instance and Bookmark ID

When you know the specific instance and bookmark:

```bash
curl -X POST "https://your-elsa-server.com/elsa/api/workflow-instances/{instanceId}/resume" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "bookmarkId": "bookmark-abc123",
    "input": {
      "result": "success"
    }
  }'
```

---

## Security Considerations

### Always Use HTTPS

Resume URLs contain sensitive tokens. Always use HTTPS to prevent interception:

```bash
# Good: HTTPS
curl -X POST "https://your-elsa-server.com/elsa/api/bookmarks/resume?t=..."

# BAD: Never use HTTP in production
# curl -X POST "http://your-elsa-server.com/elsa/api/bookmarks/resume?t=..."
```

### Token Expiration

Tokens become invalid when:
- The bookmark is burned (consumed)
- The workflow instance is cancelled
- The workflow instance is deleted

See [Security & Authentication Guide](../../security/README.md) (DOC-020) for token security best practices.

### Rate Limiting

Protect resume endpoints with rate limiting:

```bash
# If rate limited, you'll receive:
# HTTP 429 Too Many Requests
```

---

## Troubleshooting

### Bookmark Not Found (404)

Common causes:
1. **Already consumed:** Bookmark was burned on previous resume
2. **Wrong stimulus:** Payload doesn't match what the bookmark expects
3. **Workflow cancelled:** Instance no longer exists

**Debug steps:**

```bash
# Check if the workflow instance exists
curl -X GET "https://your-elsa-server.com/elsa/api/workflow-instances/{instanceId}" \
  -H "Authorization: Bearer YOUR_TOKEN"

# List bookmarks for the instance
curl -X GET "https://your-elsa-server.com/elsa/api/bookmarks?workflowInstanceId={instanceId}" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### Token Invalid (401)

Common causes:
1. **Malformed token:** Check for copy/paste errors
2. **Wrong server:** Token was generated by a different Elsa instance
3. **Key mismatch:** Server signing key changed since token was generated

### Stimulus Mismatch

The stimulus hash must match exactly. Common issues:

```bash
# These will NOT match the same bookmark:

# Original expectation
{"path": "/webhook/order-approved", "method": "POST"}

# Different order (may work depending on serialization)
{"method": "POST", "path": "/webhook/order-approved"}

# Extra field (won't match)
{"path": "/webhook/order-approved", "method": "POST", "extra": "data"}

# Missing field (won't match)
{"path": "/webhook/order-approved"}
```

**Code Reference:** `src/modules/Elsa.Workflows.Runtime/Services/WorkflowResumer.cs` — Resume logic and bookmark matching.

---

## Best Practices

1. **Store instance IDs:** When starting workflows, save the instance ID for later resume operations
2. **Use correlation IDs:** For multi-step workflows, correlation IDs simplify finding related instances
3. **Handle duplicates:** Design your workflow to handle duplicate resume attempts gracefully
4. **Log resume attempts:** Track all resume operations for debugging and audit

---

**Last Updated:** 2025-11-28
